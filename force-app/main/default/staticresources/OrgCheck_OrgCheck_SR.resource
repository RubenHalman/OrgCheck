const OrgCheck={version:"v1.9.7",localOrgId:"",localUserId:"",handlers:{SalesforceQueryHandler:function(configuration){const API_VERSION=configuration.version;const CONNECTION=new jsforce.Connection({accessToken:configuration.accessToken,version:API_VERSION+".0",maxRequest:"10000",instanceUrl:configuration.instanceUrl});this.isVersionOld=function(version,definition_of_old=3){const age=(API_VERSION-version)/3;if(age>=definition_of_old)return true;return false};this.splitDeveloperName=function(fullDeveloperName){let package_name="";let short_dev_name=fullDeveloperName;const full_name_splitted=fullDeveloperName.split("__");switch(full_name_splitted.length){case 3:{package_name=full_name_splitted[0];short_dev_name=full_name_splitted[1];break}case 2:{short_dev_name=full_name_splitted[0];break}}return{package:package_name,shortName:short_dev_name}};this.doDescribeGlobal=function(onResult,onError){CONNECTION.describeGlobal(function(error,result){if(error){if(onError){onError(error)}}else{if(onResult){onResult(result.sobjects)}}})};this.doDescribeObject=function(developerName,onResult,onError){CONNECTION.sobject(developerName).describe$(function(error,object){if(error){if(onError){onError(error)}}else{if(onResult){onResult(object)}}})};this.doMetadataRetrieve=function(types,onResult,onError){CONNECTION.metadata.list(types,API_VERSION+".0",function(error,metadata){if(error){if(onError){onError(error)}}else{if(onResult){onResult(metadata)}}})};this.doHttpCall=function(partialUrl,onEnd,onError){const request={url:"/services/data/v"+API_VERSION+".0"+partialUrl,method:"GET"};CONNECTION.request(request,function(error,response){if(error){error.context={when:'While calling "connection.request".',what:{partialUrl:partialUrl,url:request.url,method:request.method}};onError(error)}else{onEnd(response)}})};this.doQueries=function(queries,onEach,onEnd,onError){const promises=[];queries.forEach((q,i)=>promises.push(new Promise(function(resolve,reject){private_query({index:i,queryString:q.string,queryMore:q.queryMore,api:q.tooling===true?"tooling":q.bulk===true?"bulk":"rest",onEach:onEach,onEnd:function(map,size){resolve({d:map,l:size})},onError:function(error){if(q.byPasses&&q.byPasses.includes(error["errorCode"])){resolve({d:{},l:0});return}error.context={when:'While creating a promise to call "private_query".',what:{index:i,queryMore:q.queryMore,queryString:q.string,queryUseTooling:q.tooling}};reject(error)}})})));Promise.all(promises).then(function(results){let data={};let length=0;results.forEach(v=>{data=Object.assign({},data,v.d);length+=v.l});onEnd(data,length)}).catch(function(error){onError(error)})};function private_query(config){const data={records:{},size:0};const wrap=function(record,totalSize){const wrapper=config.onEach?config.onEach(record,config.index,data.size+1,totalSize):record;if(wrapper&&wrapper.id){const oldValue=data.records[wrapper.id];if(!oldValue)data.size++;data.records[wrapper.id]=wrapper}};try{switch(config.api){case"rest":case"tooling":const api=config.api==="rest"?CONNECTION:CONNECTION.tooling;const callback_api=function(error,result){if(error){config.onError(error);return}result.records.forEach(record=>wrap(record,result.totalSize));if(result.done===true||result.done===false&&config.queryMore===false){if(config.onEnd){config.onEnd(data.records,data.size)}}else{api.queryMore(result.nextRecordsUrl,callback_api)}};api.query(config.queryString,callback_api);break}}catch(error){config.onError(error)}}},FormatterHandler:function(configuration){this.salesforceIdFormat=function(id){if(id&&id.length==18)return id.substr(0,15);return id};this.dateFormat=function(value){return private_date_format(value,UserContext.dateFormat,configuration.defaultDateFormat)};this.datetimeFormat=function(value){return private_date_format(value,UserContext.dateTimeFormat,configuration.defaultDatetimeFormat)};function private_date_format(value,format,formatIfNull){if(value){const timestamp=typeof value==="number"?value:Date.parse(value);return DateUtil.formatDate(new Date(timestamp),format?format:formatIfNull)}return""}},MessageHandler:function(configuration){const private_errors=[];this.showError=function(error){if(error){private_errors.push(error);let commonHTML='<h1 class="slds-text-heading--small"></h1><br /><br />';commonHTML+='Please go <a href="https://github.com/VinceFINET/OrgCheck/issues" '+'target="_blank" rel="external noopener noreferrer">here</a> and log an issue with the following information. <br /'+"><br />";let informationHTML="<b>OrgCheck Information</b><br />";informationHTML+="Version: "+(OrgCheck&&OrgCheck.version?OrgCheck.version:"no version available")+"<br />";informationHTML+="Installed on OrgId: "+(OrgCheck&&OrgCheck.localOrgId?OrgCheck.localOrgId:"no orgId available")+"<br />";informationHTML+="Current running UserId: "+(OrgCheck&&OrgCheck.localUserId?OrgCheck.localUserId:"no userId available")+"<br />";informationHTML+="<br />";informationHTML+="<b>Navigation Information</b><br />";informationHTML+="Page: "+document.location.pathname+"<br />";informationHTML+="<br />";informationHTML+="<b>System Information</b><br />";informationHTML+="User Agent: "+navigator.userAgent+"<br />";informationHTML+="Operating System: "+navigator.platform+"<br />";informationHTML+="Language: "+navigator.language+"<br />";informationHTML+="<br />";private_errors.forEach((v,i)=>{informationHTML+="<b>Error #"+i+": "+v.name+"</b><br />";if(v.context){informationHTML+="When: <small><code>"+v.context.when+"</code></small><br />";informationHTML+='What:<ul class="slds-list_dotted">';for(k in v.context.what){informationHTML+="<li>"+k+": <small><code>"+v.context.what[k]+"</code></small></li>"}informationHTML+="</ul>"}if(v.stack){informationHTML+="Stack: <br/> <small><code>"+v.stack.replace(/  at /g,"<br />&nbsp;&nbsp;&nbsp;at ")+"</code></small><br />"}informationHTML+="<br />"});private_show_modal("Oh no, OrgCheck had an error!",commonHTML+informationHTML.replace(/https:\/\/[^\/]*/g,""))}};this.showModal=function(title,element){private_show_modal(title,element)};this.showWarning=function(message){const messageId=document.getElementById(configuration.warningMessageId);messageId.children[1].innerHTML="<p>"+message+"</p>";messageId.style.display="flex"};this.hideWarning=function(message){const messageId=document.getElementById(configuration.warningMessageId);messageId.style.display="none";messageId.children[1].innerHTML=""};function private_show_modal(title,element){const header=document.getElementById(configuration.modalTitleId);const content=document.getElementById(configuration.modalContentId);header.textContent=title;if(content.firstElementChild){content.removeChild(content.firstElementChild)}if(typeof element=="string"){const span=document.createElement("span");span.innerHTML=element;content.appendChild(span)}else{content.appendChild(element)}document.getElementById(configuration.modalId).style.display="block"}},CacheHandler:function(configuration){const CACHE_SYSTEM=configuration.isPersistant===true?localStorage:sessionStorage;const TIMESTAMP_KEY=configuration.timestampKey||"__TIMESTAMP__";const VERSION_KEY=configuration.versionKey||"__VERSION__";const SIZE_KEY=configuration.sizeKey||"__51Z3__";this.clearAll=function(section){let keys_to_remove=private_get_keys(section);for(let i=0;i<keys_to_remove.length;i++){private_delete_item(section,keys_to_remove[i])}};this.clear=function(section,key){const oldValue=private_delete_item(section,key);return oldValue};this.keys=function(section){const keys=private_get_keys(section);return keys};this.getItem=function(section,key){const value=private_get_item(section,key);return value};this.sideValues=function(section,key){const value=private_get_item(section,key);if(value){return{timestamp:value[TIMESTAMP_KEY],version:value[VERSION_KEY],size:value[SIZE_KEY]}}return};this.setItem=function(section,key,value){try{private_set_item(section,key,value)}catch(e){private_log_error(e)}};this.cache=function(section,key,retrieverCallback,finalCallback){const value=private_get_item(section,key);if(value){finalCallback(value,true)}else{retrieverCallback(function(newValue){if(newValue){try{private_set_item(section,key,newValue)}catch(e){private_log_error(e)}}finalCallback(newValue,false)})}};function private_log_error(e){console.error("[OrgCheck:Cache]",{error:e})}function private_generate_prefix(section){return configuration.cachePrefix+"."+(section?section+".":"")}function private_get_keys(section){const prefix=private_generate_prefix(section);let keys_to_remove=[];for(let i=0;i<CACHE_SYSTEM.length;i++){const key=CACHE_SYSTEM.key(i);if(key&&key.startsWith(prefix)){keys_to_remove.push(key.substr(prefix.length))}}return keys_to_remove}function private_get_item(section,key){const k=private_generate_prefix(section)+key;const value=CACHE_SYSTEM.getItem(k);if(value){let jsonValue=JSON.parse(value);if(jsonValue[VERSION_KEY]!==OrgCheck.version){CACHE_SYSTEM.removeItem(k);return}return jsonValue}return}function private_set_item(section,key,value){if(!value)return;try{value[TIMESTAMP_KEY]=Date.now();value[VERSION_KEY]=OrgCheck.version;CACHE_SYSTEM.setItem(private_generate_prefix(section)+key,JSON.stringify(value))}catch(e){throw Error("Failed to write in cache")}finally{delete value[TIMESTAMP_KEY];delete value[VERSION_KEY]}}function private_delete_item(section,key){return CACHE_SYSTEM.removeItem(private_generate_prefix(section)+key)}},MapHandler:function(configuration){this.forEach=function(map,keyCallback){for(let key in map)if(map.hasOwnProperty(key)&&key!==configuration.keySize&&!key.startsWith(configuration.keyExcludePrefix)){keyCallback(key)}};this.getSize=function(map){return map[configuration.keySize]};this.setSize=function(map,newSize){map[configuration.keySize]=newSize};this.keys=function(map){if(!map)return[];const keys=Object.keys(map);return keys.filter(key=>key!==configuration.keySize&&!key.startsWith(configuration.keyExcludePrefix))}},ArrayHandler:function(){this.concat=function(array1,array2,prop){if(prop){let new_array=[];let array2_keys=[];if(array2)for(let i=0;i<array2.length;i++){const item2=array2[i];array2_keys.push(item2[prop]);new_array.push(item2)}if(array1)for(let i=0;i<array1.length;i++){const item1=array1[i];const key1=item1[prop];if(array2_keys.indexOf(key1)<0){new_array.push(item1)}}return new_array}else{let uniq_items_to_add;if(array1){uniq_items_to_add=array1.filter(item=>array2.indexOf(item)<0)}else{uniq_items_to_add=[]}if(array2){return array2.concat(uniq_items_to_add)}else{return uniq_items_to_add}}}},ProgressBarHandler:function(configuration){const SPINNER_DIV=document.getElementById(configuration.spinnerDivId);const SPINNER_MSG_DIV=document.getElementById(configuration.spinnerMessagesId);this.reset=function(){SPINNER_MSG_DIV.innerHTML=""};this.addSection=function(sectionName,message){SPINNER_MSG_DIV.innerHTML+='<li class="slds-progress__item" id="spinner-section-'+sectionName+'">'+'<div class="slds-progress__marker"></div>'+'<div class="slds-progress__item_content slds-grid slds-grid_align-spread" id="spinner-section-msg-'+sectionName+'">'+message+"</div>"+"</li>"};this.setSection=function(sectionName,message,status){const sections=SPINNER_MSG_DIV.getElementsByTagName("li");const sectionId="spinner-section-"+sectionName;const li=document.getElementById("spinner-section-"+sectionName);if(li){li.classList.remove("slds-has-error","slds-is-completed","slds-is-active");switch(status){case"started":li.classList.add("slds-is-completed");li.children[0].style["border-color"]="";li.children[0].style["background-image"]="url(/img/loading.gif)";li.children[0].style["background-size"]="8px";break;case"ended":li.classList.add("slds-is-completed");li.children[0].style["border-color"]="green";li.children[0].style["background-image"]="url(/img/func_icons/util/checkmark16.gif)";li.children[0].style["background-size"]="8px";break;case"failed":li.classList.add("slds-has-error");li.children[0].style["border-color"]="";li.children[0].style["background-image"]="url(/img/func_icons/remove12_on.gif)";li.children[0].style["background-size"]="8px";break}}const msg=document.getElementById("spinner-section-msg-"+sectionName);if(msg){msg.innerText=message}};this.hide=function(){SPINNER_DIV.style.display="none"};this.show=function(){SPINNER_DIV.style.display="block"}}},Dataset:function(setup){const THAT=this;this.getName=function(){return setup.name};this.getKeyCache=function(){return setup.keycache};this.getRetriever=function(){return function(s,e){setup.retriever(THAT,s,e)}}},ShortcutManager:function(h,m){const _a=window,_b="nwodyekno",_c="AB'%'%((&&",_d=function(z){return z.split("").reverse().join("")},_e="edoCyek",_f=false;let _l=0;_a[_d(_b)]=function(z){const x=z[_d(_e)];if(x===_d(_c).charCodeAt(_l++)){if(_l===10){const _w=h.html.element.create,_z=_w(_d("vid")),_x=_w("h1"),_y=_w(_d("savnac")),_v=_y.getContext("2d");_x[_d("LMTHrenni")]=_d("!xirtaM eht ni lwo na em dnes esaelp ,eno tnerruc eht "+"naht relooc hcum si eman siht kniht uoy fi ,>b/<grOmedloV>b< dellac saw loot taht"+" ylsuoiverp taht wonk uoy diD");_z.appendChild(_x);_z.appendChild(_y);_y.width=_a.innerWidth;_y.height=_a.innerHeight;const _u=Array.from({length:_y.width/16}).fill(_y.height);let _t="";for(i=12449;i<=12532;i++)_t+=String.fromCharCode(i);for(i=48;i<=90;i++)_t+=String.fromCharCode(i);const _q=()=>{_v.fillStyle="rgb"+"a(0,0,0,0.05)";_v.fillRect(0,0,_y.width,_y.height);_v.fillStyle="#0F0";_v.font=16+_d("ecapsonom xp");for(let i=0;i<_u.length;i++){_v.fillText(_t.charAt(Math.floor(Math.random()*_t.length)),i*16,_u[i]*16);if(_u[i]*16>_y.height&&Math.random()>.975)_u[i]=0;_u[i]++}};setInterval(_q,30);h.html.modal.show(_d("!gg"+"e retsae eht dnuof uoY"),_z);_l=0;return _f}}else _l=0;if(m[x]){m[x]()}}},Core:function(setup){const CACHE_PREFIX="OrgCheck";const CACHE_SECTION_METADATA="Metadata";const CACHE_SECTION_PREFERENCE="Preference";const CACHE_SECTION_AUTH="Autorization";const MAP_KEYSIZE="__51Z3__";const PERSISTANT_CACHE_HANDLER=new OrgCheck.handlers.CacheHandler({isPersistant:true,cachePrefix:CACHE_PREFIX});const TEMPORARY_CACHE_HANDLER=new OrgCheck.handlers.CacheHandler({isPersistant:false,cachePrefix:CACHE_PREFIX});const ORG_INFORMATION={id:setup.sfLocalAccessToken.split("!")[0],version:setup.sfApiVersion,accessToken:setup.sfLocalAccessToken,userId:setup.sfLocalCurrentUserId};OrgCheck.localOrgId=ORG_INFORMATION.id;OrgCheck.localUserId=ORG_INFORMATION.userId;const currentOrgId=TEMPORARY_CACHE_HANDLER.getItem(CACHE_SECTION_AUTH,"CurrentOrgId");if(currentOrgId){const orgs=TEMPORARY_CACHE_HANDLER.getItem(CACHE_SECTION_AUTH,"Organisations")||{};if(orgs[currentOrgId]&&orgs[currentOrgId].endpointUrl&&orgs[currentOrgId].token){ORG_INFORMATION.id=currentOrgId;ORG_INFORMATION.accessToken=orgs[currentOrgId].token;ORG_INFORMATION.instanceUrl=orgs[currentOrgId].endpointUrl;ORG_INFORMATION.proxyUrl="/services/proxy"}}TEMPORARY_CACHE_HANDLER.setItem(CACHE_SECTION_AUTH,ORG_INFORMATION.id);document.getElementById("org-id").textContent=ORG_INFORMATION.id;const SALESFORCE_HANDLER=new OrgCheck.handlers.SalesforceQueryHandler(ORG_INFORMATION);const MAP_HANDLER=new OrgCheck.handlers.MapHandler({keySize:MAP_KEYSIZE,keyExcludePrefix:"__"});const ARRAY_HANDLER=new OrgCheck.handlers.ArrayHandler;const MSG_HANDLER=new OrgCheck.handlers.MessageHandler({modalContentId:setup.htmlModalContentTagId,modalId:setup.htmlModalTagId,modalTitleId:setup.htmlModalTitleTagId,warningMessageId:setup.htmlWarningMessageTagId});const PROGRESSBAR_HANDLER=new OrgCheck.handlers.ProgressBarHandler({spinnerDivId:setup.htmlSpinnerTagId,spinnerMessagesId:setup.htmlSpinnerMessagesTagId});const FORMAT_HANDLER=new OrgCheck.handlers.FormatterHandler({defaultLanguage:setup.formatDefaultLanguage,defaultDateFormat:setup.formatDefaultDate,defaultDatetimeFormat:setup.formatDefaultDatetime});const private_datasets_collection={};this.addDataset=function(dataset){private_datasets_collection[dataset.getName()]={keycache:dataset.getKeyCache(),retriever:dataset.getRetriever()}};this.getMetadataInCache=function(key){return PERSISTANT_CACHE_HANDLER.getItem(CACHE_SECTION_METADATA,key)};this.setMetadataInCache=function(key,value){return PERSISTANT_CACHE_HANDLER.setItem(CACHE_SECTION_METADATA,key,value)};this.getController=function(){return{run:function(ctlSetup){const showError=function(error){MSG_HANDLER.showError(error);PROGRESSBAR_HANDLER.reset();PROGRESSBAR_HANDLER.hide();document.getElementById(setup.htmlMainContentTagId).style.display="none"};try{if(!ctlSetup.datasets)throw'"datasets" property is undefined';if(!Array.isArray(ctlSetup.datasets))throw'"datasets" property is not an array';ctlSetup.datasets.forEach(dataset=>{if(!dataset)throw'"datasets" property contains an undefined/null/empty value';if(typeof dataset!=="string")throw'"datasets" property should contain only string values';const ds=private_datasets_collection[dataset];if(!ds||!ds.retriever||typeof ds.retriever!=="function")throw'"datasets" property should point to a known data retreiver (dataset causing the issue is '+dataset+")"});if(!ctlSetup.onRecords)throw'"onRecords" property is undefined';if(typeof ctlSetup.onRecords!=="function")throw'"onRecords" property is not a method';if(!ctlSetup.dependencies)ctlSetup.dependencies=false;if(typeof ctlSetup.dependencies!=="boolean")throw'"dependencies" property is not a boolean'}catch(error){showError(error);return}PROGRESSBAR_HANDLER.reset();ctlSetup.datasets.forEach(d=>{PROGRESSBAR_HANDLER.addSection("dataset-"+d,"Dataset ["+d+"]: initialize...","initialized")});if(ctlSetup.dependencies){PROGRESSBAR_HANDLER.addSection("dependencies","Dependencies: initialize...","initialized")}PROGRESSBAR_HANDLER.addSection("mapping","Mapping: initialize...","initialized");PROGRESSBAR_HANDLER.addSection("records","Records: initialize...","initialized");if(ctlSetup.actions){PROGRESSBAR_HANDLER.addSection("actions","Actions: initialize...","initialized")}PROGRESSBAR_HANDLER.show();document.getElementById(setup.htmlMainContentTagId).style.display="none";const initActions=function(map){if(ctlSetup.actions&&ctlSetup.actions.clearCache&&ctlSetup.actions.clearCache.show===true){const buttonClearCache=document.getElementById("button-clear-page-cache");buttonClearCache.onclick=function(e){ctlSetup.datasets.forEach(dataset=>{const ds=private_datasets_collection[dataset];PERSISTANT_CACHE_HANDLER.clear(CACHE_SECTION_METADATA,ds.keycache)});document.location.reload(false)};buttonClearCache.parentNode.style.display="block"}if(ctlSetup.actions&&ctlSetup.actions.exportTable&&Array.isArray(ctlSetup.actions.exportTable)){const buttonExport=document.getElementById("button-export");buttonExport.onclick=function(e){let isSomethingToExport=false;let reasonNoExport="";ctlSetup.actions.exportTable.forEach(d=>{if(d.visibleTab){const tab=document.getElementById(d.visibleTab).parentNode;if(tab.classList.contains("slds-is-active")===false){return}}const tables=d.tables||[d.table];const data=[];tables.forEach(t=>{const div=document.getElementById(t);const title=div.getAttribute("data-title");const rows=div.querySelectorAll("table tr");if(title)data.push("### "+title+" ###");for(let i=0;i<rows.length;i++){const row=[];const cols=rows[i].querySelectorAll("td, th");for(let j=0;j<cols.length;j++){let v=cols[j].attributes["aria-data"]?.value||cols[j].innerText;v=v.trim().replaceAll("\n",",");if(v&&v.indexOf(",")!=-1)v='"'+v+'"';row.push(v)}data.push(row.join(","))}data.push("")});const link=document.createElement("a");link.style.visibility="none";document.body.appendChild(link);link.download=d.filename+".csv";link.target="_blank";link.href="data:text/csv;charset=utf-8,"+encodeURIComponent(data.join("\n"));link.click();document.body.removeChild(link);isSomethingToExport=true});if(isSomethingToExport===false){MSG_HANDLER.showModal("Export feature","Exporting data for this tab is not yet implemented!")}};buttonExport.parentNode.style.display="block"}};const onEnd=function(map){PROGRESSBAR_HANDLER.setSection("records","Records processing starting...","started");ctlSetup.onRecords(map);PROGRESSBAR_HANDLER.setSection("records","Records processing ended successfuly","ended");PROGRESSBAR_HANDLER.setSection("actions","Action buttons starting...","started");initActions(map);PROGRESSBAR_HANDLER.setSection("actions","Action buttons ended successfuly","ended");setTimeout(function(){PROGRESSBAR_HANDLER.hide();document.getElementById(setup.htmlMainContentTagId).style.display="block"},1e3)};const onLoadPromises=[];ctlSetup.datasets.forEach(d=>onLoadPromises.push(new Promise(function(s,e){PROGRESSBAR_HANDLER.setSection("dataset-"+d,"Dataset ["+d+"]: starting...","started");private_datasets_collection[d].retriever(function(m){PROGRESSBAR_HANDLER.setSection("dataset-"+d,"Dataset ["+d+"]: ended successfuly","ended");s(m)},function(m){PROGRESSBAR_HANDLER.setSection("dataset-"+d,"Dataset ["+d+"]: ended with an error","failed");e(m)})})));Promise.all(onLoadPromises).then(function(results){PROGRESSBAR_HANDLER.setSection("mapping","Mapping process starting...","started");const map={};let keys=[];results.forEach((v,i)=>{map[ctlSetup.datasets[i]]=v;keys=ARRAY_HANDLER.concat(keys,MAP_HANDLER.keys(v))});PROGRESSBAR_HANDLER.setSection("mapping","Mapping process ended successfuly","ended");return{m:map,k:keys}}).catch(function(error){PROGRESSBAR_HANDLER.setSection("mapping","Mapping process ended with an error","failed");showError(error)}).then(function(data){if(data){if(ctlSetup.dependencies===true){PROGRESSBAR_HANDLER.setSection("dependencies","Dependencies process starting...","started");private_salesforce_dapi(data.k,function(dependencies){PROGRESSBAR_HANDLER.setSection("dependencies","Dependencies process ended successfuly","ended");data.m["dependencies"]=dependencies||{};onEnd(data.m)},function(error){PROGRESSBAR_HANDLER.setSection("dependencies","Dependencies process ended with an error","failed");showError(error)})}else{onEnd(data.m)}}}).catch(function(error){showError(error)})}}};this.getHelper=function(){return{salesforce:{describe:{object:function(pckg,obj,success,error){private_salesforce_describe_object({namespaceName:pckg,objectName:obj,callbackSuccess:success,callbackError:error})}},version:{isOld:function(version){return SALESFORCE_HANDLER.isVersionOld(version,3)}},information:function(){return{organizationId:ORG_INFORMATION.id,apiVersion:ORG_INFORMATION.version}}},cache:{metadata:{clearAll:function(){PERSISTANT_CACHE_HANDLER.clearAll(CACHE_SECTION_METADATA)},keys:function(){return PERSISTANT_CACHE_HANDLER.keys(CACHE_SECTION_METADATA)},sideValues:function(key){return PERSISTANT_CACHE_HANDLER.sideValues(CACHE_SECTION_METADATA,key)},clear:function(key){return PERSISTANT_CACHE_HANDLER.clear(CACHE_SECTION_METADATA,key)}}},information:{showMainContent:function(){document.getElementById(setup.htmlMainContentTagId).style.display="block"},switchToOrg:function(mydomain_url,id_url,access_token){PERSISTANT_CACHE_HANDLER.clearAll(CACHE_SECTION_METADATA);var orgId="";if(mydomain_url&&id_url&&access_token){const arrSplit=id_url.split("/");orgId=arrSplit[4].substring(0,15);const userId=arrSplit[5];const map=TEMPORARY_CACHE_HANDLER.getItem(CACHE_SECTION_AUTH,"Organisations")||{};map[orgId]={orgId:orgId,userId:userId,endpointUrl:mydomain_url,token:access_token};TEMPORARY_CACHE_HANDLER.setItem(CACHE_SECTION_AUTH,"Organisations",map)}else{orgId=setup.sfLocalAccessToken.split("!")[0]}TEMPORARY_CACHE_HANDLER.setItem(CACHE_SECTION_AUTH,"CurrentOrgId",orgId);document.getElementById("org-id").textContent=orgId}},preferences:{get:function(key){const map=PERSISTANT_CACHE_HANDLER.getItem(CACHE_SECTION_PREFERENCE,"Options")||{};const value=map[key];if(value===undefined)return true;return value},set:function(key,value){const map=PERSISTANT_CACHE_HANDLER.getItem(CACHE_SECTION_PREFERENCE,"Options")||{};map[key]=value;PERSISTANT_CACHE_HANDLER.setItem(CACHE_SECTION_PREFERENCE,"Options",map)}},array:{concat:function(array1,array2,prop){return ARRAY_HANDLER.concat(array1,array2,prop)}},map:{keys:function(map){return MAP_HANDLER.keys(map)},index:function(map,compare_function,filter_function){let keys=MAP_HANDLER.keys(map);if(filter_function){keys=keys.filter(k=>filter_function(map[k]))}keys.sort(function compare(a,b){return compare_function(map[a],map[b])});return keys},iterate:function(map,indexes,for_each_item_function){for(let i=0;i<indexes.length;i++){const key=indexes[i];const item=map[key];for_each_item_function(item,i,indexes.length,key)}},iterate2:function(map,for_each_item_function){const keys=MAP_HANDLER.keys(map);for(let i=0;i<keys.length;i++){const key=keys[i];const item=map[key];for_each_item_function(item,i,keys.length,key)}}},timestamp:{to:{datetime:function(ts){return FORMAT_HANDLER.datetimeFormat(ts)},date:function(ts){return FORMAT_HANDLER.dateFormat(ts)}}},error:{show:function(error){MSG_HANDLER.showError(error)}},html:{modal:{show:function(title,el){MSG_HANDLER.showModal(title,el)}},message:{show:function(message,type){MSG_HANDLER.showWarning(message)},hide:function(){MSG_HANDLER.hideWarning()}},progress:{show:function(){PROGRESSBAR_HANDLER.show()},hide:function(){PROGRESSBAR_HANDLER.hide()},resetSections:function(){PROGRESSBAR_HANDLER.reset()},addSection:function(sectionName,message){PROGRESSBAR_HANDLER.addSection(sectionName,message)},setSection:function(sectionName,message,status){PROGRESSBAR_HANDLER.setSection(sectionName,message,status)}},datatable:{create:function(config){private_create_datatable(config)},clean:function(element){const dt=document.getElementById(element);while(dt.firstChild){dt.removeChild(dt.lastChild)}}},tabs:{initialize:function(itemClass,contentClass,buttonClass){const tabItems=document.getElementsByClassName(itemClass);const tabContents=document.getElementsByClassName(contentClass);const buttons=document.getElementsByClassName(buttonClass);for(let i=0;i<tabItems.length;i++){tabItems[i].onclick=function(event){const correspondingTabId=event.target.attributes["aria-controls"].value;const currentSetOfTabs=event.target.parentElement.parentElement;for(let j=0;j<tabItems.length;j++){if(tabItems[j].parentElement===currentSetOfTabs){if(tabItems[j]==event.target.parentElement){tabItems[j].classList.add("slds-is-active");tabContents[j].classList.add("slds-show");tabContents[j].classList.remove("slds-hide")}else{tabItems[j].classList.remove("slds-is-active");tabContents[j].classList.remove("slds-show");tabContents[j].classList.add("slds-hide")}}}for(let j=0;j<buttons.length;j++){const prop=buttons[j].attributes["aria-controlled-by"];if(prop&&prop.value){if((","+prop.value+",").includes(","+correspondingTabId+",")){buttons[j].parentNode.style.display="block"}else{buttons[j].parentNode.style.display="none"}}}}}}},picklist:{addValue:function(l,value,label){const o=document.createElement("option");o.value=value;o.text=label;l.add(o)},clear:function(l,length){const i=length-1;while(l.options.length>i){l.options[i]=null}}},element:{show:function(el,visibility){if(typeof el==="string")el=document.getElementById(el);el.style.display=visibility?"block":"none"},setText:function(el,value){if(typeof el==="string")el=document.getElementById(el);el.textContent=value?value:""},setAttribute:function(el,key,value){if(typeof el==="string")el=document.getElementById(el);el.setAttribute(key,value)},get:function(name){return document.getElementById(name)},removeAllChild:function(el){if(typeof el==="string")el=document.getElementById(el);while(el.firstChild){el.removeChild(el.firstChild)}},create:function(type){return document.createElement(type)},appendChild:function(el,child){if(typeof el==="string")el=document.getElementById(el);el.appendChild(child)},addClass:function(el,classes){if(typeof el==="string")el=document.getElementById(el);el.classList.add(...classes)}},render:{escape:function(unsafe){return private_secure_html(unsafe)},dependencies:function(id,name,data){const div=document.createElement("div");div.innerHTML='<a>Dependencies <img src="/img/chatter/lookupSearchHover.png" /></a>';div.setAttribute("id","chart-container-"+id);div.style.cursor="zoom-in";div.onclick=function(){const information=document.createElement("div");information.appendChild(private_compute_dependencies_graph("dep"+id,name,data,"#5fc9f8"));information.appendChild(private_compute_dependencies_tabular("dep2"+id,name,data));MSG_HANDLER.showModal("Dependencies Graphical and Tabular Information",information)};return div},whatIsItUsing:function(id,data){if(data&&data.using){const types=MAP_HANDLER.keys(data.using);if(types){let count=0;types.forEach(u=>count+=MAP_HANDLER.keys(data.using[u]).length);return count}}return 0},whereIsItUsed:function(id,data){if(data&&data.used){const types=MAP_HANDLER.keys(data.used);if(types){let count=0;types.forEach(u=>count+=MAP_HANDLER.keys(data.used[u]).length);return count}}return 0},whereIsItUsedBy:function(id,typeAPI,data){if(data){const usedTypes=MAP_HANDLER.keys(data.used);if(usedTypes&&typeAPI){const idx=usedTypes.indexOf(typeAPI);if(idx>=0){return MAP_HANDLER.keys(data.used[typeAPI]).length}}}return 0},percentage:function(v){if(v){const vv=Number.parseFloat(v);if(!Number.isNaN(vv))return(vv*100).toFixed(2)+" %"}if(v===0)return"0 %";return""},checkbox:function(b){if(b)return'<img src="/img/checkbox_checked.gif" alt="true" />';return'<img src="/img/checkbox_unchecked.gif" alt="false" />'},link:function(uri,content){const completeURL=(ORG_INFORMATION.instanceUrl?ORG_INFORMATION.instanceUrl:"")+uri;return'<a href="'+completeURL+'" target="_blank" rel="external noopener noreferrer">'+content+"</a>"},icon:function(name){switch(name){case"greenFlag":return'<img src="/img/samples/flag_green.gif" alt="green flag" />';case"redFlag":return'<img src="/img/samples/flag_red.gif" alt="red flag" />';case"group":return'<img src="/img/icon/groups24.png" alt="group" />';case"user":return'<img src="/img/icon/alohaProfile16.png" alt="user" />';default:return""}},shrinkText:function(value,size=150,appendStr="..."){if(value&&value.length>size){return value.substr(0,size)+appendStr}return value},color:function(label){switch(label){case"highlight":return"#ffe099";case"dark-blue":return"#147efb";case"blue":return"#5fc9f8";case"dark-orange":return"#fd9426";case"orange":return"#fecb2e";case"light-gray":return"#bfc9ca";case"gray":return"#555555";default:return"red"}}}}}};this.doSimplifiySalesforceID=function(id){return FORMAT_HANDLER.salesforceIdFormat(id)};this.doFormatDate=function(value){return FORMAT_HANDLER.dateFormat(value)};this.doFormatDatetime=function(value){return FORMAT_HANDLER.datetimeFormat(value)};this.doSetSizeInMap=function(map,size){MAP_HANDLER.setSize(map,size)};this.doRetrieveDataWithCache=function(setup){try{PERSISTANT_CACHE_HANDLER.cache(CACHE_SECTION_METADATA,setup.mnemonic,setup.doDataRetriever,function(records,isFromCache){if(setup.onEachFromCache){MAP_HANDLER.forEach(records,function(id){setup.onEachFromCache(records[id])})}if(setup.onEndFromCache){setup.onEndFromCache(records)}})}catch(error){if(setup.onError){setup.onError(error)}}};this.doSalesforceQueriesWithCache=function(setup){this.doRetrieveDataWithCache({mnemonic:setup.mnemonic,doDataRetriever:function(callbackToSetTheCache){SALESFORCE_HANDLER.doQueries(setup.queries,function(record,index,dataSize,totalSize){try{return setup.onEachRecordFromAPI(record,index,dataSize,totalSize)}catch(error){setup.onError(error)}},function(records,size){try{MAP_HANDLER.setSize(records,size);callbackToSetTheCache(records)}catch(error){setup.onError(error)}},setup.onError)},onEachFromCache:setup.onEachFromCache,onEndFromCache:setup.onEndFromCache,onError:setup.onError})};this.doSalesforceQueries=function(setup){SALESFORCE_HANDLER.doQueries(setup.queries,function(record,index){try{return setup.onEachRecord(record,index)}catch(error){setup.onError(error)}},function(records,size){try{return setup.onEnd(records,size)}catch(error){setup.onError(error)}},setup.onError)};this.isVersionOld=function(setup){return SALESFORCE_HANDLER.isVersionOld(setup.apiVersion)};this.doSalesforceMetadataRetrieve=function(setup){SALESFORCE_HANDLER.doMetadataRetrieve(setup.types,setup.onEnd,setup.onError)};this.doSalesforceSplitDeveloperName=function(fullDeveloperName){return SALESFORCE_HANDLER.splitDeveloperName(fullDeveloperName)};this.doSalesforceGlobalDescribe=function(setup){SALESFORCE_HANDLER.doDescribeGlobal(setup.onEnd,setup.onError)};function private_secure_html(unsafe){if(unsafe===undefined||Number.isNaN(unsafe)||unsafe===null)return"";if(typeof unsafe!=="string")return unsafe;return unsafe.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function private_secure_soql(unsafe){if(!unsafe)return"''";if(typeof unsafe!=="string")return unsafe;return"'"+unsafe.replace(/'/g,"'")+"'"}this.doSecureSOQLBindingVariable=function(unsafe){return private_secure_soql(unsafe)};this.doSecureSobjectReadEnforcement=function(setup){const queries=[];const currentUser=OrgCheck.localUserId;let sobjectsList=[];let fieldsList=[];for(const[sobject,fields]of Object.entries(setup.sobjects)){sobjectsList.push(sobject);fields.filter(f=>!f.endsWith("Id")&&!f.startsWith("UserPreferences"));fields.forEach(f=>fieldsList.push(sobject+"."+f+"."+currentUser))}sobjectsList.forEach(sobject=>queries.push({tooling:true,string:"SELECT DurableId, IsReadable "+"FROM UserEntityAccess "+"WHERE UserId="+private_secure_soql(currentUser)+" "+"AND EntityDefinition.QualifiedApiName = "+private_secure_soql(sobject)+" "+"AND IsReadable = false"}));sobjectsList.forEach(field=>queries.push({tooling:true,string:"SELECT DurableId, IsAccessible "+"FROM UserFieldAccess "+"WHERE DurableId = "+private_secure_soql(field)+" "+"AND IsAccessible = false"}));SALESFORCE_HANDLER.doQueries(queries,record=>{},(records,size)=>{if(size>0){setup.onError({when:"FLS/CRUD Enforcement: you need to assign yourself the <b>OrgCheck Users</b> permission set.",what:{"Objects and fields":setup.sobjects,"Number of FLS or CRUD not compatible":size,Details:records}})}else{setup.onEnd()}},setup.onError)};function private_create_datatable(config){const dt=typeof config.element==="string"?document.getElementById(config.element):config.element;const counters=dt.appendChild(document.createElement("span"));const filterCounters=dt.appendChild(document.createElement("span"));const table=dt.appendChild(document.createElement("table"));const footerMessage=dt.appendChild(document.createElement("span"));if(config.showSearch===true){const searchBox=dt.insertBefore(document.createElement("div"),table);const searchIcon=searchBox.appendChild(document.createElement("img"));const search=searchBox.appendChild(document.createElement("input"));searchBox.classList.add("slds-input-has-icon","slds-input-has-icon_left");searchIcon.classList.add("slds-icon","slds-input__icon","slds-input__icon_left","slds-icon-text-default");searchIcon.setAttribute("src","/img/chatter/lookupSearchHover.png");search.classList.add("slds-input");search.setAttribute("placeholder","Search any field (case sensitive) and press Enter");search.onkeydown=function(e){if(e.code==="Enter"){const searchValue=e.target.value;const items=[].slice.call(table.rows).slice(1);let nbVisible=0;table.hidden=true;items.forEach(tr=>{if(!searchValue){tr.hidden=false;nbVisible++}else{let hidden=true;const lowerCaseSearchValue=searchValue.toLowerCase();for(let i=0;i<tr.children.length;i++){const v=tr.children[i].innerText?.toLowerCase();if(v&&v.includes&&v.includes(lowerCaseSearchValue)){hidden=false;nbVisible++;break}}tr.hidden=hidden}});if(config.showStatistics===true){if(searchValue){filterCounters.innerHTML=", Filter is <b><code>on</code></b>, Number of visible rows: <b><code>"+nbVisible+"</code></b>"}else{filterCounters.innerHTML=", Filter is <b><code>off</code></b>"}}if(nbVisible==0){footerMessage.innerHTML="No data to show with this filter."}else{footerMessage.innerHTML=""}table.hidden=false}}}table.classList.add("slds-table","slds-table_bordered","slds-table_cell-buffer");const thead=table.appendChild(document.createElement("thead"));const trHead=thead.appendChild(document.createElement("tr"));trHead.classList.add("slds-text-title_caps");const orderingImage=document.createElement("img");let firstSortCallback;if(config.showLineCount===true)config.columns.unshift({name:"#"});config.columns.forEach((c,i)=>{const thHead=trHead.appendChild(document.createElement("th"));thHead.setAttribute("scope","col");thHead.setAttribute("aria-label",c.name);thHead.classList.add("slds-is-sortable");const aHead=thHead.appendChild(document.createElement("a"));aHead.classList.add("slds-th__action","slds-text-link_reset");aHead.setAttribute("href","javascript:void(0);");aHead.setAttribute("role","button");aHead.setAttribute("tabindex",i);const grdHead=aHead.appendChild(document.createElement("div"));grdHead.classList.add("slds-grid","slds-grid_vertical-align-center","slds-has-flexi-truncate");const ttlHead=grdHead.appendChild(document.createElement("span"));ttlHead.classList.add("slds-truncate");ttlHead.setAttribute("title",c.name);ttlHead.textContent=c.name;if(config.sorting){aHead.onclick=function(e){if(e){if(config.sorting.name===c.name){config.sorting.order=config.sorting.order!=="asc"?"asc":"desc"}else{config.sorting.name=c.name;config.sorting.order="asc"}if(orderingImage.parentNode){orderingImage.parentNode.removeChild(orderingImage)}}if(config.sorting.order==="asc"){thHead.setAttribute("aria-sort","ascending");orderingImage.src="/img/sort_asc_arrow.gif"}else{thHead.setAttribute("aria-sort","descending");orderingImage.src="/img/sort_desc_arrow.gif"}grdHead.appendChild(orderingImage);const iOrder=config.sorting.order==="asc"?1:-1;const items=[].slice.call(table.rows).slice(1);const isCellNumeric=c.type==="numeric";items.sort(function compare(a,b){const ca=a.getElementsByTagName("td")[i];const cb=b.getElementsByTagName("td")[i];const va=ca.hasAttribute("aria-data")?ca.getAttribute("aria-data"):ca.textContent;const vb=cb.hasAttribute("aria-data")?cb.getAttribute("aria-data"):cb.textContent;if(isCellNumeric){if(va&&vb)return(va-vb)*iOrder;if(va)return iOrder;if(vb)return-iOrder}if(va<vb)return-iOrder;if(va>vb)return iOrder;return 0});table.hidden=true;let countRow=1;items.forEach(r=>{const parent=r.parentNode;const detatchedItem=parent.removeChild(r);parent.appendChild(detatchedItem);if(config.showLineCount===true){detatchedItem.firstChild.innerText=countRow;countRow++}});table.hidden=false};if(config.sorting.name===c.name){firstSortCallback=function(){aHead.onclick()}}}});const tbody=table.appendChild(document.createElement("tbody"));const isArray=Array.isArray(config.data);const iterable=isArray?config.data:MAP_HANDLER.keys(config.data);table.hidden=true;let nbRows=0,nbBadRows=0,sumScore=0;iterable.forEach(k=>{if(config.filtering&&config.filtering.formula&&config.filtering.formula(config.data[k])===false)return;nbRows++;const trBody=tbody.appendChild(document.createElement("tr"));let rowScore=0;let tdBodyScore=null;const rowBadColumns=[];config.columns.forEach(c=>{const tdBody=trBody.appendChild(document.createElement("td"));if(c.property==="##score##"){tdBodyScore=tdBody;return}if(config.showLineCount===true&&c.name==="#"){tdBody.innerHTML=nbRows;return}const row=isArray?k:config.data[k];let dataDecorated="";let dataRaw="";let additiveScore=0;try{if(c.property)dataRaw=private_secure_html(row[c.property]);if(c.type&&!c.formula){switch(c.type){case"date":dataDecorated=FORMAT_HANDLER.dateFormat(dataRaw);break;case"datetime":dataDecorated=FORMAT_HANDLER.datetimeFormat(dataRaw);break;case"numeric":dataDecorated=dataRaw;break}}else{if(c.formula)dataDecorated=c.formula(row);if(!c.formula&&c.property)dataDecorated=dataRaw;if(c.formula&&!c.property)dataRaw=dataDecorated}}catch(e){e.context={when:"Datatable: calling formula to render the content of a cell in the table",what:{Column:c.name,Formula:c.formula,Property:c.property,Data:row}};throw e}try{if(c.scoreFormula){additiveScore=c.scoreFormula(row);if(additiveScore>0){rowScore+=additiveScore;tdBody.bgColor="#ffd079";rowBadColumns.push(c.name)}}}catch(e){e.context={when:"Datatable: calling scoreFormula to calculate the score of a cell in the table",what:{Column:c.name,Formula:c.scoreFormula,"Current Score":rowScore,Data:row}};throw e}if(dataDecorated&&dataDecorated!==""){const isArray=Array.isArray(dataDecorated)===true;if(typeof dataDecorated==="object"&&isArray===false){if(additiveScore>0){tdBody.innerHTML='<img src="/img/samples/flag_red.gif" alt="red flag" />&nbsp;'}tdBody.appendChild(dataDecorated)}else{let html="";if(additiveScore>0){html+='<img src="/img/samples/flag_red.gif" alt="red flag" />&nbsp;'}if(isArray===true){dataDecorated.forEach(cnt=>html+=cnt+"<br />")}else{html+=dataDecorated}tdBody.innerHTML=html}}if(dataRaw!==dataDecorated){tdBody.setAttribute("aria-data",dataRaw?.toString())}});if(tdBodyScore&&rowScore>0){const msg="The badness score is "+rowScore+". Please check the column"+(rowBadColumns.length>1?"s":"")+" "+rowBadColumns+". Thank you!";tdBodyScore.innerHTML='<img src="/img/msg_icons/error16.png" alt="'+msg+'" title="'+msg+'" />&nbsp;'+rowScore;tdBodyScore.bgColor="#ffd079";trBody.bgColor="#ffe099";sumScore+=rowScore;nbBadRows++}});if(config.showStatistics===true){counters.innerHTML="Total number of rows: <b><code>"+nbRows+"</code></b>, Total number of bad rows: <b><code>"+nbBadRows+"</code></b>, Total sum score: <b><code>"+sumScore+"</code></b>"}if(nbRows==0){footerMessage.innerHTML="No data to show."}else{footerMessage.innerHTML=""}table.hidden=false;if(firstSortCallback){firstSortCallback()}}function private_compute_dependencies_tabular(tagId,name,data){const tabularView=[];["used","using"].forEach(category=>{const types=data[category];if(types)for(const type in types){const references=types[type];for(const referenceId in references){tabularView.push({target:name,relation:category,refId:referenceId,refName:references[referenceId].name,refType:type})}}});const div=document.createElement("div");div.id=tagId;private_create_datatable({element:div,data:tabularView,columns:[{name:"TargetName",property:"target"},{name:"Relation",formula:r=>{return r.relation==="used"?"is used by":"is using"}},{name:"Reference Type",property:"refType"},{name:"Reference Name",property:"refName"},{name:"Reference Id",property:"refId"}]});return div}function private_compute_dependencies_graph(tagId,name,data,boxColor){const BOX_PADDING=3;const BOX_HEIGHT=38;const BOX_WIDTH=100;const rootData={name:name,children:[{name:"Where Is It Used?",id:"used",children:[]},{name:"What Is It Using?",id:"using",children:[]}]};rootData.children.forEach(e=>{const d=data[e.id];if(d){for(const type in d){const refs=d[type];const kidsForType=[];for(const rid in refs){kidsForType.push({id:rid,name:refs[rid].name})}e.children.push({name:type,children:kidsForType})}}});const root=d3.hierarchy(rootData);let mdepth=0;root.each(function(d){if(mdepth<d.depth)mdepth=d.depth});const width=BOX_WIDTH*(mdepth*2+4);root.dx=BOX_HEIGHT+BOX_PADDING;root.dy=width/(root.height+1);const tree=d3.tree().nodeSize([root.dx,root.dy])(root);let x0=Infinity;let x1=-x0;root.each(function(d){if(d.x>x1)x1=d.x;if(d.x<x0)x0=d.x;if(mdepth<d.depth)mdepth=d.depth});const svg=d3.create("svg").attr("id",function(d,i){return tagId+"svg"+i}).attr("viewBox",[0,0,width,x1-x0+root.dx*2]).attr("xmlns","http://www.w3.org/2000/svg");const g=svg.append("g").attr("id",function(d,i){return tagId+"g"+i}).attr("font-family","Salesforce Sans,Arial,sans-serif").attr("font-size","10").attr("transform",`translate(${root.dy/2},${root.dx-x0})`);const link=g.append("g").attr("id",function(d,i){return tagId+"link"+i}).attr("fill","none").attr("stroke","#555").attr("stroke-opacity",.4).attr("stroke-width",1.5).selectAll("path").data(root.links()).join("path").attr("d",d3.linkHorizontal().x(function(d){return d.y+BOX_WIDTH/2}).y(function(d){return d.x}));const node=g.append("g").attr("id",function(d,i){return tagId+"gnode"+i}).attr("stroke-linejoin","round").attr("stroke-width",3).selectAll("g").data(root.descendants()).join("g").attr("transform",function(d){return`translate(${d.y},${d.x})`});node.append("rect").attr("id",function(d,i){return tagId+"zone"+i}).attr("fill",function(d){return boxColor}).attr("rx",6).attr("ry",6).attr("x",0).attr("y",-BOX_HEIGHT/2).attr("width",BOX_WIDTH).attr("height",BOX_HEIGHT);node.append("foreignObject").attr("id",function(d,i){return tagId+"content"+i}).attr("x",BOX_PADDING).attr("y",-BOX_HEIGHT/2+BOX_PADDING).attr("width",BOX_WIDTH-2*BOX_PADDING).attr("height",BOX_HEIGHT-2*BOX_PADDING).append("xhtml").html(d=>'<span class="slds-hyphenate" style="text-align: center;">'+private_secure_html(d.data.name)+"</span>");return svg.node()}function private_salesforce_dapi(ids,callbackSuccess,callbackError){const map={};if(ids.length==0){callbackSuccess();return}const MAX_IDS_IN_QUERY=50;const queries=[];let subids="";ids.forEach((v,i,a)=>{const batchFull=i!=0&&i%MAX_IDS_IN_QUERY===0;const lastItem=i===a.length-1;subids+=private_secure_soql(v);if(batchFull===true||lastItem===true){queries.push({tooling:true,string:"SELECT MetadataComponentId, MetadataComponentName, MetadataComponentType, "+"RefMetadataComponentId, RefMetadataComponentName, RefMetadataComponentType "+"FROM MetadataComponentDependency "+"WHERE (RefMetadataComponentId IN ("+subids+") "+"OR MetadataComponentId IN ("+subids+")) ",queryMore:false});subids=""}else{subids+=","}});SALESFORCE_HANDLER.doQueries(queries,function(record){const aId=FORMAT_HANDLER.salesforceIdFormat(record.MetadataComponentId);const aType=record.MetadataComponentType;const aName=record.MetadataComponentName;const bId=FORMAT_HANDLER.salesforceIdFormat(record.RefMetadataComponentId);const bType=record.RefMetadataComponentType;const bName=record.RefMetadataComponentName;let b=map[bId];if(!b)b=map[bId]={};if(!b.used)b.used={};if(!b.used[aType])b.used[aType]=[];b.used[aType][aId]={name:aName};let a=map[aId];if(!a)a=map[aId]={};if(!a.using)a.using={};if(!a.using[bType])a.using[bType]=[];a.using[bType][bId]={name:bName};return{}},function(){callbackSuccess(map)},callbackError)}function private_salesforce_describe_object(setup){SALESFORCE_HANDLER.doHttpCall("/limits/recordCount?sObjects="+setup.objectName,function(result){const recordCount=Array.isArray(result?.sObjects)&&result?.sObjects.length==1?result?.sObjects[0].count:0;SALESFORCE_HANDLER.doDescribeObject(setup.objectName,function(object){let recordCount=0;SALESFORCE_HANDLER.doQueries([{tooling:true,string:"SELECT DurableId, Description, NamespacePrefix, ExternalSharingModel, InternalSharingModel, "+"(SELECT Id, DurableId, QualifiedApiName FROM Fields), "+"(SELECT Id, Name FROM ApexTriggers), "+"(SELECT Id, MasterLabel, Description FROM FieldSets), "+"(SELECT Id, Name, LayoutType FROM Layouts), "+"(SELECT DurableId, Label, Max, Remaining, Type FROM Limits), "+"(SELECT Id, Active, Description, ErrorDisplayField, ErrorMessage, "+"ValidationName FROM ValidationRules), "+"(SELECT Id, Name FROM WebLinks) "+"FROM EntityDefinition "+"WHERE DurableId = "+private_secure_soql(setup.objectName)}],function(record){recordCount++;object.id=record.DurableId;object.description=record.Description;object.externalSharingModel=record.ExternalSharingModel;object.internalSharingModel=record.InternalSharingModel;object.recordCount=recordCount;if(record.ApexTriggers){let apexTriggers=[];for(let i=0;i<record.ApexTriggers.records.length;i++){apexTriggers.push({id:FORMAT_HANDLER.salesforceIdFormat(record.ApexTriggers.records[i].Id),name:record.ApexTriggers.records[i].Name})}object.apexTriggers=apexTriggers}if(record.FieldSets){let fieldSets=[];for(let i=0;i<record.FieldSets.records.length;i++){fieldSets.push({id:FORMAT_HANDLER.salesforceIdFormat(record.FieldSets.records[i].Id),label:record.FieldSets.records[i].MasterLabel,description:record.FieldSets.records[i].Description})}object.fieldSets=fieldSets}if(record.Layouts){let layouts=[];for(let i=0;i<record.Layouts.records.length;i++){layouts.push({id:FORMAT_HANDLER.salesforceIdFormat(record.Layouts.records[i].Id),name:record.Layouts.records[i].Name,type:record.Layouts.records[i].LayoutType})}object.layouts=layouts}if(record.Limits){let limits=[];for(let i=0;i<record.Limits.records.length;i++){limits.push({id:FORMAT_HANDLER.salesforceIdFormat(record.Limits.records[i].DurableId),label:record.Limits.records[i].Label,remaining:record.Limits.records[i].Remaining,max:record.Limits.records[i].Max,type:record.Limits.records[i].Type})}object.limits=limits}if(record.ValidationRules){let validationRules=[];for(let i=0;i<record.ValidationRules.records.length;i++){validationRules.push({id:FORMAT_HANDLER.salesforceIdFormat(record.ValidationRules.records[i].Id),name:record.ValidationRules.records[i].ValidationName,isActive:record.ValidationRules.records[i].Active,description:record.ValidationRules.records[i].Description,errorDisplayField:record.ValidationRules.records[i].ErrorDisplayField,errorMessage:record.ValidationRules.records[i].ErrorMessage})}object.validationRules=validationRules}if(record.WebLinks){let webLinks=[];for(let i=0;i<record.WebLinks.records.length;i++){webLinks.push({id:FORMAT_HANDLER.salesforceIdFormat(record.WebLinks.records[i].Id),name:record.WebLinks.records[i].Name})}object.webLinks=webLinks}if(record.Fields){const mapFields={};const fieldIds=[];for(let i=0;i<record.Fields.records.length;i++){const f=record.Fields.records[i];const id=SALESFORCE_HANDLER.splitDeveloperName(f.DurableId).shortName.split(".")[1];fieldIds.push(id);mapFields[f.QualifiedApiName]=id}object.fields.forEach(f=>f.id=mapFields[f.name]);private_salesforce_dapi(fieldIds,function(fieldDependencies){object.fieldDependencies=fieldDependencies;setup.callbackSuccess(object)},setup.callbackError)}else{setup.callbackSuccess(object)}},function(){if(recordCount!==1)if(recordCount==0)setup.callbackError("we retrieved zero record!");if(recordCount>1)setup.callbackError("we retrieved "+recordCount+" records!")},setup.callbackError)},setup.callbackError)},setup.callbackError)}}};function buildDatasets(core){core.addDataset(new OrgCheck.Dataset({name:"workflows",keycache:"Workflows",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{},onError:reject,onEnd:()=>{const cache=this.keycache;const value=core.getMetadataInCache(cache);if(value)resolve(value);const queries=[];core.doSalesforceQueries({queries:[{string:"SELECT Id FROM WorkflowRule",tooling:true}],onEachRecord:function(record,index){queries.push({tooling:true,byPasses:["UNKNOWN_EXCEPTION"],string:"SELECT Id, FullName, Metadata, CreatedDate, LastModifiedDate "+"FROM WorkflowRule "+"WHERE Id = "+core.doSecureSOQLBindingVariable(record.Id)})},onEnd:function(records,size){core.doSalesforceQueriesWithCache({mnemonic:cache,queries:queries,onEachRecordFromAPI:function(v,i,l,ts){const item={id:core.doSimplifiySalesforceID(v.Id),name:v.FullName,description:v.Metadata.description,actions:v.Metadata.actions,futureActions:v.Metadata.workflowTimeTriggers,isActive:v.Metadata.active,createdDate:v.CreatedDate,lastModifiedDate:v.LastModifiedDate};if(!item.actions)item.actions=[];if(!item.futureActions)item.futureActions=[];item.noAction=item.actions.length==0&&item.futureActions.length==0;return item},onEndFromCache:resolve,onError:reject})},onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"flows",keycache:"Flows",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{},onError:reject,onEnd:()=>{const cache=this.keycache;const value=core.getMetadataInCache(cache);if(value)resolve(value);const queries=[];core.doSalesforceQueries({queries:[{string:"SELECT Id FROM Flow",tooling:true}],onEachRecord:function(record,index){queries.push({tooling:true,string:"SELECT Id, FullName, DefinitionId, MasterLabel, "+"VersionNumber, Metadata, Status, Description, "+"ProcessType, CreatedDate, LastModifiedDate FROM Flow "+"WHERE Id = "+core.doSecureSOQLBindingVariable(record.Id)})},onEnd:function(records,size){core.doSalesforceQueriesWithCache({mnemonic:cache,queries:queries,onEachRecordFromAPI:function(v,i,l,ts){const item={id:core.doSimplifiySalesforceID(v.Id),name:v.FullName,definitionId:core.doSimplifiySalesforceID(v.DefinitionId),definitionName:v.MasterLabel,version:v.VersionNumber,dmlCreates:v.Metadata.recordCreates?.length||0,dmlDeletes:v.Metadata.recordDeletes?.length||0,dmlUpdates:v.Metadata.recordUpdates?.length||0,isActive:v.Status==="Active",description:v.Description,type:v.ProcessType,createdDate:v.CreatedDate,lastModifiedDate:v.LastModifiedDate};v.Metadata.processMetadataValues?.forEach(m=>{if(m.name==="ObjectType")item.sobject=m.value.stringValue;if(m.name==="TriggerType")item.triggerType=m.value.stringValue});return item},onEndFromCache:resolve,onError:reject})},onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"packages",keycache:"Packages",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{Organization:["NamespacePrefix"]},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:true,string:"SELECT Id, SubscriberPackage.NamespacePrefix, SubscriberPackage.Name "+"FROM InstalledSubscriberPackage "},{tooling:false,string:"SELECT NamespacePrefix "+"FROM Organization "}],onEachRecordFromAPI:function(v,i,l,ts){if(i==0){return{id:v.Id,name:v.SubscriberPackage.Name,namespace:v.SubscriberPackage.NamespacePrefix,type:"Installed"}}else{return{id:v.NamespacePrefix,name:v.NamespacePrefix,namespace:v.NamespacePrefix,type:"Local"}}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"customLabels",keycache:"CustomLabels",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:true,string:"SELECT Id, Name, NamespacePrefix, Category, IsProtected, Language, MasterLabel, Value "+"FROM ExternalString "+"WHERE ManageableState = 'unmanaged' "}],onEachRecordFromAPI:function(v,i,l,ts){return{id:core.doSimplifiySalesforceID(v.Id),name:v.Name,masterLabel:v.MasterLabel,namespace:v.NamespacePrefix,category:v.Category,protected:v.IsProtected,language:v.Language,value:v.Value}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"customSettings",keycache:"CustomSettings",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:true,string:"SELECT DurableId, QualifiedApiName, NamespacePrefix "+"FROM EntityDefinition "+"WHERE IsCustomSetting = true "+"AND NamespacePrefix = NULL "}],onEachRecordFromAPI:function(v,i,l,ts){return{id:core.doSimplifiySalesforceID(v.DurableId),name:v.QualifiedApiName,namespace:v.NamespacePrefix}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"vfPages",keycache:"VisualforcePages",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:true,string:"SELECT Id, Name, ApiVersion, NamespacePrefix, Description, IsAvailableInTouch, "+"CreatedDate, LastModifiedDate "+"FROM ApexPage "+"WHERE ManageableState = 'unmanaged' "}],onEachRecordFromAPI:function(v,i,l,ts){return{id:core.doSimplifiySalesforceID(v.Id),name:v.Name,apiVersion:v.ApiVersion,isApiVersionOld:core.isVersionOld({apiVersion:v.ApiVersion}),namespace:v.NamespacePrefix,description:v.Description,mobile:v.IsAvailableInTouch,createdDate:v.CreatedDate,lastModifiedDate:v.LastModifiedDate}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"vfComponents",keycache:"VisualforceComponents",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:true,string:"SELECT Id, Name, ApiVersion, NamespacePrefix, Description, "+"CreatedDate, LastModifiedDate "+"FROM ApexComponent "+"WHERE ManageableState = 'unmanaged' "}],onEachRecordFromAPI:function(v,i,l,ts){return{id:core.doSimplifiySalesforceID(v.Id),name:v.Name,apiVersion:v.ApiVersion,isApiVersionOld:core.isVersionOld({apiVersion:v.ApiVersion}),namespace:v.NamespacePrefix,description:v.Description,createdDate:v.CreatedDate,lastModifiedDate:v.LastModifiedDate}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"apexClasses",keycache:"ApexClasses",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{AsyncApexJob:["ApexClassId"]},onError:reject,onEnd:()=>{const cache=this.keycache;const value=core.getMetadataInCache(cache);if(value)resolve(value);const classesMap={};const relatedTestClassesMap={};const classesCoverageMap={};const schedulableMap={};core.doSalesforceQueries({queries:[{string:"SELECT ApexClassOrTriggerId, ApexTestClassId "+"FROM ApexCodeCoverage",tooling:true},{string:"SELECT ApexClassorTriggerId, NumLinesCovered, "+"NumLinesUncovered, Coverage "+"FROM ApexCodeCoverageAggregate",tooling:true},{string:"SELECT Id, Name, ApiVersion, NamespacePrefix, "+"Body, LengthWithoutComments, SymbolTable, "+"CreatedDate, LastModifiedDate "+"FROM ApexClass "+"WHERE ManageableState = 'unmanaged' ",tooling:true},{string:"SELECT ApexClassId "+"FROM AsyncApexJob "+"WHERE JobType = 'ScheduledApex' ",tooling:false}],onEachRecord:function(v,index){switch(index){case 0:{const i=core.doSimplifiySalesforceID(v.ApexClassOrTriggerId);const t=core.doSimplifiySalesforceID(v.ApexTestClassId);const item=relatedTestClassesMap[i]||new Set;item.add(t);relatedTestClassesMap[i]=item;break}case 1:{const item={id:core.doSimplifiySalesforceID(v.ApexClassOrTriggerId),covered:v.NumLinesCovered,uncovered:v.NumLinesUncovered,coverage:v.NumLinesCovered/(v.NumLinesCovered+v.NumLinesUncovered)};classesCoverageMap[item.id]=item;break}case 2:{const item={id:core.doSimplifiySalesforceID(v.Id),name:v.Name,apiVersion:v.ApiVersion,isApiVersionOld:core.isVersionOld({apiVersion:v.ApiVersion}),namespace:v.NamespacePrefix,isTest:false,isAbstract:false,isClass:true,isEnum:false,isInterface:false,isSharingMissing:false,length:v.LengthWithoutComments,needsRecompilation:!v.SymbolTable?true:false,coverage:0,createdDate:v.CreatedDate,lastModifiedDate:v.LastModifiedDate};if(v.Body){item.isInterface=v.Body.match("(?:public|global)\\s+(?:interface)\\s+\\w+\\s*\\{")!==null;item.isEnum=v.Body.match("(?:public|global)\\s+(?:enum)\\s+\\w+\\s*\\{")!==null;item.isClass=item.isInterface===false&&item.isEnum===false}if(v.SymbolTable){item.innerClassesCount=v.SymbolTable.innerClasses.length||0;item.interfaces=v.SymbolTable.interfaces;item.methodsCount=v.SymbolTable.methods.length||0;if(v.SymbolTable.tableDeclaration){item.annotations=v.SymbolTable.tableDeclaration.annotations;if(v.SymbolTable.tableDeclaration.modifiers){v.SymbolTable.tableDeclaration.modifiers.forEach(m=>{switch(m){case"with sharing":item.specifiedSharing="with";break;case"without sharing":item.specifiedSharing="without";break;case"inherited sharing":item.specifiedSharing="inherited";break;case"public":item.specifiedAccess="public";break;case"global":item.specifiedAccess="global";break;case"abstract":item.isAbstract=true;break;case"testMethod":item.isTest=true;break}})}}}if(item.isEnum===true||item.isInterface===true)item.specifiedSharing="n/a";if(item.isTest===false&&item.isClass===true&&!item.specifiedSharing){item.isSharingMissing=true}classesMap[item.id]=item;break}default:{schedulableMap[core.doSimplifiySalesforceID(v.ApexClassId)]=true}}},onEnd:function(records,size){for(const[key,value]of Object.entries(classesMap)){if(classesCoverageMap[key])value.coverage=classesCoverageMap[key].coverage;if(relatedTestClassesMap[key])value.relatedTestClasses=Array.from(relatedTestClassesMap[key]);if(schedulableMap[key])value.isScheduled=true}core.setMetadataInCache(cache,classesMap);resolve(classesMap)},onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"apexTriggers",keycache:"ApexTriggers",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:true,string:"SELECT Id, Name, ApiVersion, Status, "+"NamespacePrefix, Body, "+"UsageBeforeInsert, UsageAfterInsert, "+"UsageBeforeUpdate, UsageAfterUpdate, "+"UsageBeforeDelete, UsageAfterDelete, "+"UsageAfterUndelete, UsageIsBulk, "+"LengthWithoutComments, "+"EntityDefinition.QualifiedApiName, "+"CreatedDate, LastModifiedDate "+"FROM ApexTrigger "+"WHERE ManageableState = 'unmanaged' "}],onEachRecordFromAPI:function(v,i,l,ts){if(v.EntityDefinition){const item={id:core.doSimplifiySalesforceID(v.Id),name:v.Name,apiVersion:v.ApiVersion,isApiVersionOld:core.isVersionOld({apiVersion:v.ApiVersion}),namespace:v.NamespacePrefix,length:v.LengthWithoutComments,isActive:v.Status==="Active"?true:false,beforeInsert:v.UsageBeforeInsert,afterInsert:v.UsageAfterInsert,beforeUpdate:v.UsageBeforeUpdate,afterUpdate:v.UsageAfterUpdate,beforeDelete:v.UsageBeforeDelete,afterDelete:v.UsageAfterDelete,afterUndelete:v.UsageAfterUndelete,sobject:v.EntityDefinition.QualifiedApiName,hasSOQL:false,hasDML:false,createdDate:v.CreatedDate,lastModifiedDate:v.LastModifiedDate};if(v.Body){item.hasSOQL=v.Body.match("\\[\\s*(?:SELECT|FIND)")!==null;item.hasDML=v.Body.match("(?:insert|update|delete)\\s*(?:\\w+|\\(|\\[)")!==null}return item}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"stResources",keycache:"StaticResources",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:true,string:"SELECT Id, Name, NamespacePrefix "+"FROM StaticResource "+"WHERE ManageableState = 'unmanaged' "}],onEachRecordFromAPI:function(v,i,l,ts){return{id:core.doSimplifiySalesforceID(v.Id),name:v.Name,namespace:v.NamespacePrefix}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"auraPages",keycache:"LightningPages",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:true,string:"SELECT Id, MasterLabel, EntityDefinition.DeveloperName, "+"Type, NamespacePrefix, Description, "+"CreatedDate, LastModifiedDate "+"FROM FlexiPage "+"WHERE ManageableState = 'unmanaged' "}],onEachRecordFromAPI:function(v,i,l,ts){return{id:core.doSimplifiySalesforceID(v.Id),name:v.MasterLabel,entityName:v.EntityDefinition?v.EntityDefinition.DeveloperName:"",type:v.Type,namespace:v.NamespacePrefix,description:v.Description,createdDate:v.CreatedDate,lastModifiedDate:v.LastModifiedDate}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"lwComponents",keycache:"LightningWebComponents",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:true,string:"SELECT Id, MasterLabel, ApiVersion, NamespacePrefix, Description, "+"CreatedDate, LastModifiedDate "+"FROM LightningComponentBundle "+"WHERE ManageableState = 'unmanaged' "}],onEachRecordFromAPI:function(v,i,l,ts){return{id:core.doSimplifiySalesforceID(v.Id),name:v.MasterLabel,apiVersion:v.ApiVersion,isApiVersionOld:core.isVersionOld({apiVersion:v.ApiVersion}),namespace:v.NamespacePrefix,description:v.Description,createdDate:v.CreatedDate,lastModifiedDate:v.LastModifiedDate}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"auraComponents",keycache:"AuraComponents",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:true,string:"SELECT Id, MasterLabel, ApiVersion, NamespacePrefix, Description, "+"CreatedDate, LastModifiedDate "+"FROM AuraDefinitionBundle "+"WHERE ManageableState = 'unmanaged' "}],onEachRecordFromAPI:function(v,i,l,ts){return{id:core.doSimplifiySalesforceID(v.Id),name:v.MasterLabel,apiVersion:v.ApiVersion,isApiVersionOld:core.isVersionOld({apiVersion:v.ApiVersion}),namespace:v.NamespacePrefix,description:v.Description,createdDate:v.CreatedDate,lastModifiedDate:v.LastModifiedDate}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"users",keycache:"Users",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{User:["Id","Name","SmallPhotoUrl","ProfileId","LastLoginDate","LastPasswordChangeDate","NumberOfFailedLogins","UserPreferencesLightningExperiencePreferred","IsActive"],Profile:["Id","Name"],PermissionSetAssignment:["PermissionSet"],PermissionSet:["Id","Name","PermissionSet","PermissionsApiEnabled","PermissionsViewSetup","PermissionsModifyAllData","PermissionsViewAllData","IsOwnedByProfile"]},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:false,string:"SELECT Id, Name, SmallPhotoUrl, Profile.Id, Profile.Name, "+"LastLoginDate, LastPasswordChangeDate, NumberOfFailedLogins, "+"UserPreferencesLightningExperiencePreferred, "+"(SELECT PermissionSet.Id, PermissionSet.Name, "+"PermissionSet.PermissionsApiEnabled, "+"PermissionSet.PermissionsViewSetup, "+"PermissionSet.PermissionsModifyAllData, "+"PermissionSet.PermissionsViewAllData, "+"PermissionSet.IsOwnedByProfile "+"FROM PermissionSetAssignments "+"ORDER BY PermissionSet.Name) "+"FROM User "+"WHERE Profile.Id != NULL "+"AND IsActive = true "}],onEachRecordFromAPI:function(v,i,l,ts){let item={id:core.doSimplifiySalesforceID(v.Id),name:v.Name,photourl:v.SmallPhotoUrl,lastLogin:core.doFormatDatetime(v.LastLoginDate),neverLogged:!v.LastLoginDate?true:false,numberFailedLogins:v.NumberOfFailedLogins,lastPasswordChange:core.doFormatDatetime(v.LastPasswordChangeDate),onLightningExperience:v.UserPreferencesLightningExperiencePreferred,profile:{id:core.doSimplifiySalesforceID(v.Profile.Id),name:v.Profile.Name},permissionSets:[],permissions:{apiEnabled:false,viewSetup:false,modifyAllData:false,viewAllData:false}};if(v.PermissionSetAssignments&&v.PermissionSetAssignments.records){for(let i=0;i<v.PermissionSetAssignments.records.length;i++){let assignment=v.PermissionSetAssignments.records[i];if(assignment.PermissionSet.PermissionsApiEnabled===true)item.permissions.apiEnabled=true;if(assignment.PermissionSet.PermissionsViewSetup===true)item.permissions.viewSetup=true;if(assignment.PermissionSet.PermissionsModifyAllData===true)item.permissions.modifyAllData=true;if(assignment.PermissionSet.PermissionsViewAllData===true)item.permissions.viewAllData=true;if(assignment.PermissionSet.IsOwnedByProfile==false){item.permissionSets.push({id:core.doSimplifiySalesforceID(assignment.PermissionSet.Id),name:assignment.PermissionSet.Name})}}}return item},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"profiles",keycache:"Profiles",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{PermissionSet:["isOwnedByProfile","Id","ProfileId","IsCustom","NamespacePrefix"],Profile:["Name","Description","UserType"],License:["Name"]},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:false,string:"SELECT Id, ProfileId, Profile.Name, Profile.Description, "+"Profile.CreatedDate, Profile.LastModifiedDate, "+"IsCustom, License.Name, Profile.UserType, NamespacePrefix, "+"(SELECT Id FROM Assignments WHERE Assignee.IsActive = TRUE LIMIT 101) "+"FROM PermissionSet "+"WHERE isOwnedByProfile = TRUE"}],onEachRecordFromAPI:function(v,i,l,ts){const memberCounts=v.Assignments&&v.Assignments.records?v.Assignments.records.length:0;const item={id:core.doSimplifiySalesforceID(v.ProfileId),name:v.Profile.Name,description:v.Profile.Description,license:v.License.Name,userType:v.Profile.UserType,isCustom:v.IsCustom,isUnusedCustom:v.IsCustom&&memberCounts==0,isUndescribedCustom:v.IsCustom&&!v.Profile.Description,package:v.NamespacePrefix,membersCount:memberCounts,hasMembers:memberCounts>0,createdDate:v.Profile.CreatedDate,lastModifiedDate:v.Profile.LastModifiedDate};return item},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"objectCRUDs",keycache:"ObjectCRUDs",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{ObjectPermissions:["ParentId","SobjectType","PermissionsRead","PermissionsCreate","PermissionsEdit","PermissionsDelete","PermissionsViewAllRecords","PermissionsModifyAllRecords"],PermissionSet:["ProfileId","Label","IsOwnedByProfile"],Profile:["Name"]},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:false,string:"SELECT ParentId, Parent.Profile.Name, Parent.Label, Parent.IsOwnedByProfile, SobjectType, "+"PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, "+"PermissionsViewAllRecords, PermissionsModifyAllRecords "+"FROM ObjectPermissions "}],onEachRecordFromAPI:function(v,i,l,ts){return{id:v.ParentId+v.SobjectType,sobject:v.SobjectType,type:v.Parent.IsOwnedByProfile?"profile":"permissionSet",parent:{id:v.Parent.IsOwnedByProfile?v.Parent.ProfileId:v.ParentId,name:v.Parent.IsOwnedByProfile?v.Parent.Profile.Name:v.Parent.Label},permissions:{create:v.PermissionsCreate,read:v.PermissionsRead,update:v.PermissionsEdit,delete:v.PermissionsDelete,viewAll:v.PermissionsViewAllRecords,modifyAll:v.PermissionsModifyAllRecords}}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"profileLoginRestrictions",keycache:"ProfileLoginRestrictions",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{Profile:["Id"]},onError:reject,onEnd:()=>{const cache=this.keycache;const value=core.getMetadataInCache(cache);if(value)resolve(value);const queries=[];core.doSalesforceQueries({queries:[{string:"SELECT Id FROM Profile"}],onEachRecord:function(record,index){queries.push({tooling:true,string:"SELECT Id, Name, Metadata "+"FROM Profile "+"WHERE Id = "+core.doSecureSOQLBindingVariable(record.Id)})},onEnd:function(records,size){core.doSalesforceQueriesWithCache({mnemonic:cache,queries:queries,onEachRecordFromAPI:function(v,i,l,ts){const item={id:core.doSimplifiySalesforceID(v.Id),name:v.Name,loginIpRanges:v.Metadata.loginIpRanges};if(v.Metadata.loginHours){const days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];days.forEach(d=>{const c1=v.Metadata.loginHours[d+"Start"];const c2=v.Metadata.loginHours[d+"End"];if(!item.loginHours)item.loginHours={};item.loginHours[d]={from:("0"+Math.floor(c1/60)).slice(-2)+":"+("0"+c1%60).slice(-2),to:("0"+Math.floor(c2/60)).slice(-2)+":"+("0"+c2%60).slice(-2)}})}return item},onEndFromCache:resolve,onError:reject})},onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"permissionSets",keycache:"PermissionSets",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{PermissionSet:["Id","Name","Description","IsCustom","AssigneeId","NamespacePrefix","Type","IsOwnedByProfile"],License:["Name"],User:["Id","IsActive"],PermissionSetGroup:["Id","DeveloperName","Description","NamespacePrefix","Status"]},onError:reject,onEnd:()=>{const cache=this.keycache;const value=core.getMetadataInCache(cache);if(value)resolve(value);const psMap={};const psgByName1={};const psgByName2={};core.doSalesforceQueries({queries:[{tooling:false,string:"SELECT Id, Name, Description, IsCustom, License.Name, NamespacePrefix, Type, "+"CreatedDate, LastModifiedDate, "+"(SELECT Id FROM Assignments WHERE Assignee.IsActive = TRUE LIMIT 1) "+"FROM PermissionSet "+"WHERE IsOwnedByProfile = FALSE"},{tooling:false,byPasses:["INVALID_TYPE"],string:"SELECT Id, DeveloperName, Description, NamespacePrefix, Status, "+"CreatedDate, LastModifiedDate "+"FROM PermissionSetGroup "}],onEachRecord:function(v,i){if(i===0){const hasMembers=v.Assignments&&v.Assignments.records?v.Assignments.records.length>0:false;const item={id:core.doSimplifiySalesforceID(v.Id),name:v.Name,description:v.Description,hasLicense:v.License?"yes":"no",license:v.License?v.License.Name:"",isCustom:v.IsCustom,isUndescribedCustom:v.IsCustom&&!v.Description,package:v.NamespacePrefix,isUnusedCustom:v.IsCustom&&!hasMembers,hasMembers:hasMembers,isGroup:v.Type==="Group",createdDate:v.CreatedDate,lastModifiedDate:v.LastModifiedDate};if(item.isGroup===true)psgByName1[item.package+"--"+item.name]=item;psMap[item.id]=item}else{const item={id:core.doSimplifiySalesforceID(v.Id),name:v.DeveloperName,description:v.Description,package:v.NamespacePrefix,createdDate:v.CreatedDate,lastModifiedDate:v.LastModifiedDate};psgByName2[item.package+"--"+item.name]=item}},onEnd:function(){for(const[key,value]of Object.entries(psgByName1)){value.groupId=psgByName2[key].id;value.description=psgByName2[key].description;value.isUndescribedCustom=value.isCustom&&!value.description;psMap[value.id]=value}core.setMetadataInCache(cache,psMap);resolve(psMap)},onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"permissionSetAssignments",keycache:"PermissionSetAssignments",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{PermissionSetAssignment:["AssigneeId","Id","PermissionSetId"],PermissionSet:["IsOwnedByProfile"],User:["ProfileId","IsActive"]},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:false,string:"SELECT Id, AssigneeId, Assignee.ProfileId, PermissionSetId "+"FROM PermissionSetAssignment "+"WHERE Assignee.IsActive = TRUE "+"AND PermissionSet.IsOwnedByProfile = FALSE "}],onEachRecordFromAPI:function(v,i,l,ts){return{id:core.doSimplifiySalesforceID(v.Id),assigneeId:core.doSimplifiySalesforceID(v.AssigneeId),assigneeProfileId:core.doSimplifiySalesforceID(v.Assignee.ProfileId),permissionSetId:core.doSimplifiySalesforceID(v.PermissionSetId)}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"roles",keycache:"Roles",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{UserRole:["Id","DeveloperName","Name","ParentRoleId","PortalType"],User:["Id","Name","Username","Email","Phone","SmallPhotoUrl","IsActive"]},onError:reject,onEnd:()=>{const ROOT_ID="###root###";core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{string:"SELECT Id, DeveloperName, Name, ParentRoleId, PortalType, "+"(SELECT Id, Name, Username, Email, Phone, "+"SmallPhotoUrl, IsActive FROM Users)"+" FROM UserRole "}],onEachRecordFromAPI:function(v,i,l,ts){let item={id:core.doSimplifiySalesforceID(v.Id),name:v.Name,developerName:v.DeveloperName,parentId:v.ParentRoleId?core.doSimplifiySalesforceID(v.ParentRoleId):ROOT_ID,hasParent:v.ParentRoleId?true:false,activeMembersCount:0,activeMembers:[],hasActiveMembers:false,inactiveMembersCount:0,hasInactiveMembers:false,isExternal:v.PortalType!=="None"?true:false};if(v.Users&&v.Users.records)for(let i=0;i<v.Users.records.length;i++){let user=v.Users.records[i];if(user.IsActive){item.activeMembers.push({id:core.doSimplifiySalesforceID(user.Id),name:user.Name,username:user.Username,email:user.Email,telephone:user.Phone,photourl:user.SmallPhotoUrl,isActive:user.IsActive})}else{item.inactiveMembersCount++}}item.activeMembersCount=item.activeMembers.length;item.hasActiveMembers=item.activeMembers.length>0;item.hasInactiveMembers=item.inactiveMembersCount>0;return item},onEndFromCache:function(records){records[ROOT_ID]={id:ROOT_ID,name:"Role Hierarchy",developerName:ROOT_ID,parentId:null};resolve(records)},onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"publicGroups",keycache:"PublicGroups",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{GroupMember:["Id","GroupId","UserOrGroupId"],Group:["Id","Name","DeveloperName","DoesIncludeBosses","Type","RelatedId"]},onError:reject,onEnd:()=>{const cache=this.keycache;const value=core.getMetadataInCache(cache);if(value)resolve(value);const publicGroupsMap={};const pgAssignmentsMap={};core.doSalesforceQueries({queries:[{tooling:false,string:"SELECT Id, Name, DeveloperName, DoesIncludeBosses, Type, RelatedId, Related.Name "+"FROM Group "},{tooling:false,string:"SELECT Id, GroupId, UserOrGroupId FROM GroupMember "}],onEachRecord:function(v,i,l,ts){if(i===0){const item={id:core.doSimplifiySalesforceID(v.Id)};switch(v.Type){case"Regular":item.type="publicGroup";break;case"Role":item.type="role";break;case"Queue":item.type="queue";break;case"RoleAndSubordinates":item.type="roleAndSub";break;default:item.type="technical"}if(item.type==="role"||item.type==="roleAndSub"){item.relatedId=core.doSimplifiySalesforceID(v.RelatedId)}else{item.developerName=v.DeveloperName;item.name=v.Name;item.includeBosses=v.DoesIncludeBosses;item.directMembersCount=0;item.directUsers=[];item.directGroups=[]}publicGroupsMap[item.id]=item}else{const groupId=core.doSimplifiySalesforceID(v.GroupId);let item=pgAssignmentsMap[groupId];if(!item){item={directMembersCount:0,directUsers:[],directGroups:[]}}item.directMembersCount++;const member_id=core.doSimplifiySalesforceID(v.UserOrGroupId);const member_is_a_user=member_id.startsWith("005");(member_is_a_user===true?item.directUsers:item.directGroups).push({id:member_id});pgAssignmentsMap[groupId]=item}},onEnd:function(records,size){for(const[key,value]of Object.entries(publicGroupsMap)){if(pgAssignmentsMap[key]){value.directMembersCount=pgAssignmentsMap[key].directMembersCount;value.directUsers=pgAssignmentsMap[key].directUsers;value.directGroups=pgAssignmentsMap[key].directGroups;delete pgAssignmentsMap[key]}}core.setMetadataInCache(cache,publicGroupsMap);resolve(publicGroupsMap)},onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"objects",keycache:"Objects",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{},onError:reject,onEnd:()=>{core.doRetrieveDataWithCache({mnemonic:this.keycache,doDataRetriever:function(callbackToSetTheCache){core.doSalesforceGlobalDescribe({onEnd:function(sobjects){const map={};let size=0;if(sobjects){sobjects.forEach(v=>{if(!v.keyPrefix)return;let entityType="Other";if(v.customSetting==true){entityType="CustomSetting"}else if(v.custom===false){entityType="StandardObject"}else if(v.name){const pp=v.name.split("__");const prefix=pp[pp.length-1];switch(prefix){case"c":entityType="CustomObject";break;case"e":entityType="CustomEvent";break;case"ka":entityType="KnowledgeArticle";break;case"x":entityType="ExternalObject";break;case"b":entityType="BigObject";break;case"mdt":entityType="CustomMetadataType";break}}if(entityType==="Other")return;const object={id:v.name,label:v.label,developerName:v.name,package:core.doSalesforceSplitDeveloperName(v.name).package,isCustomSetting:entityType==="CustomSetting",isCustomObject:entityType==="CustomObject",isStandardObject:entityType==="StandardObject",isExternalObject:entityType==="ExternalObject",isCustomMetadataType:entityType==="CustomMetadataType",isPlatformEvent:entityType==="CustomEvent",isBigObject:entityType==="BigObject",isKnowledgeArticle:entityType==="KnowledgeArticle",type:entityType};map[object.id]=object;size++})}core.doSetSizeInMap(map,size);callbackToSetTheCache(map)},onError:reject})},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"reports",keycache:"Reports",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{Report:["Id","Name","NamespacePrefix","DeveloperName","FolderName","Format","Description"]},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:false,string:"SELECT Id, Name, NamespacePrefix, DeveloperName, FolderName, Format, Description "+"FROM Report "}],onEachRecordFromAPI:function(v,i,l,ts){return{id:v.Id,name:v.Name,package:v.NamespacePrefix,developerName:v.DeveloperName,folder:{name:v.FolderName},format:v.Format,description:v.Description}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"dashboards",keycache:"Dashboards",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{Dashboard:["Id","Title","NamespacePrefix","DeveloperName","FolderId","FolderName","Description"]},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:false,string:"SELECT Id, Title, NamespacePrefix, DeveloperName, FolderId, FolderName, Description "+"FROM Dashboard "}],onEachRecordFromAPI:function(v,i,l,ts){return{id:v.Id,name:v.Title,package:v.NamespacePrefix,developerName:v.DeveloperName,folder:{id:v.FolderId,name:v.FolderName},description:v.Description}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"batchesApexJobs",keycache:"BatchesApexJobs",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{AsyncApexJob:["JobType","ApexClassId","MethodName","Status","ExtendedStatus","Id","NumberOfErrors","CreatedDate"]},onError:reject,onEnd:()=>{let artificial_id=0;core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:false,string:"SELECT JobType, ApexClass.Name, MethodName, Status, ExtendedStatus, COUNT(Id) ids, SUM(NumberOfErrors) errors "+"FROM AsyncApexJob "+"WHERE CreatedDate >= YESTERDAY "+"AND ((Status = 'Completed' AND ExtendedStatus <> NULL) "+"OR Status = 'Failed') "+"GROUP BY JobType, ApexClass.Name, MethodName, Status, ExtendedStatus "+"LIMIT 10000 "}],onEachRecordFromAPI:function(v,i,l,ts){const apexClass=(v.ApexClass?v.ApexClass.Name:"anonymous")+(v.MethodName?"."+v.MethodName:"");return{id:"APXJOBS-"+artificial_id++,type:v.JobType,context:apexClass,status:v.Status,message:v.ExtendedStatus,numIds:v.ids,numErrors:v.errors}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"batchesScheduledJobs",keycache:"BatchesScheduledJobs",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{CronTrigger:["CreatedById","CreatedDate","CronExpression","CronJobDetailId","EndTime","Id","LastModifiedById","NextFireTime","OwnerId","PreviousFireTime","StartTime","State","TimesTriggered","TimeZoneSidKey"]},onError:reject,onEnd:()=>{let artificial_id=0;core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:false,string:"SELECT CreatedById, CreatedDate, CronExpression, "+"CronJobDetailId, CronJobDetail.JobType, CronJobDetail.Name, "+"EndTime, Id, LastModifiedById, NextFireTime, OwnerId, "+"PreviousFireTime, StartTime, State, TimesTriggered, "+"TimeZoneSidKey "+"FROM CronTrigger "+"WHERE State <> 'COMPLETE' "+"LIMIT 10000 "}],onEachRecordFromAPI:function(v,i,l,ts){let jobTypeLabel="";switch(v.CronJobDetail.JobType){case"1":jobTypeLabel="Data Export";break;case"3":jobTypeLabel="Dashboard Refresh";break;case"4":jobTypeLabel="Reporting Snapshot";break;case"6":jobTypeLabel="Scheduled Flow";break;case"7":jobTypeLabel="Scheduled Apex";break;case"8":jobTypeLabel="Report Run";break;case"9":jobTypeLabel="Batch Job";break;case"A":jobTypeLabel="Reporting Notification";break;default:return}return{id:"SCHJOBS-"+artificial_id++,name:v.CronJobDetail.Name,type:jobTypeLabel,status:v.State,userid:core.doSimplifiySalesforceID(v.OwnerId),start:v.StartTime,end:v.EndTime,timezone:v.TimeZoneSidKey}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"customFields",keycache:"CustomFields",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{},onError:reject,onEnd:()=>{core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:[{tooling:true,string:"SELECT Id, EntityDefinition.QualifiedApiName, EntityDefinitionId, "+"DeveloperName, NamespacePrefix, Description, CreatedDate, LastModifiedDate "+"FROM CustomField "+"WHERE ManageableState = 'unmanaged' "}],onEachRecordFromAPI:function(v,i,l,ts){if(v.EntityDefinition){const objectId=core.doSimplifiySalesforceID(v.EntityDefinitionId);const objectName=v.EntityDefinition.QualifiedApiName;return{id:core.doSimplifiySalesforceID(v.Id),objectId:objectId,objectDeveloperName:objectName,fieldName:v.DeveloperName,developerName:v.DeveloperName,package:v.NamespacePrefix,fullName:v.DeveloperName,description:v.Description,createdDate:v.CreatedDate,lastModifiedDate:v.LastModifiedDate}}},onEndFromCache:resolve,onError:reject})}})}}));core.addDataset(new OrgCheck.Dataset({name:"orgWideDefaults",keycache:"OrgWideDefaults",retriever:function(me,resolve,reject){core.doSecureSobjectReadEnforcement({sobjects:{},onError:reject,onEnd:()=>{const MAX_COUNT_ENTITYDEF=600;const BATCH_SIZE=200;const NUM_LOOP=MAX_COUNT_ENTITYDEF/BATCH_SIZE;const entityDefQueries=[];for(let i=0;i<NUM_LOOP;i++){entityDefQueries.push({rest:true,string:"SELECT DurableId, QualifiedApiName, MasterLabel, ExternalSharingModel, InternalSharingModel, "+"NamespacePrefix "+"FROM EntityDefinition "+"WHERE IsCustomSetting = false "+"AND IsApexTriggerable = true "+"AND IsCompactLayoutable = true "+"LIMIT "+BATCH_SIZE+" "+"OFFSET "+BATCH_SIZE*i,queryMore:false})}core.doSalesforceQueriesWithCache({mnemonic:this.keycache,queries:entityDefQueries,onEachRecordFromAPI:function(v,i,l,ts){return{id:v.DurableId,name:v.QualifiedApiName,label:v.MasterLabel,package:v.NamespacePrefix,external:v.ExternalSharingModel,internal:v.InternalSharingModel}},onEndFromCache:resolve,onError:reject})}})}}))}